# PackNet-Jittor: åŸºäºŽJittorçš„PackNetç®—æ³•å®žçŽ°

æœ¬é¡¹ç›®æ˜¯å¯¹CVPR 2018è®ºæ–‡ã€ŠPackNet: Adding Multiple Tasks to a Single Network by Iterative Pruningã€‹çš„å®Œæ•´å¤çŽ°ï¼Œä½¿ç”¨Jittoræ·±åº¦å­¦ä¹ æ¡†æž¶å®žçŽ°ã€‚

## ðŸ“– è®ºæ–‡ç®€ä»‹

**PackNet**çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨å¤§åž‹ç¥žç»ç½‘ç»œä¸­çš„å†—ä½™å‚æ•°ï¼Œé€šè¿‡"è¿­ä»£å‰ªæžå’Œé‡è®­ç»ƒ"çš„å¾ªçŽ¯ï¼Œå°†å¤šä¸ªä»»åŠ¡ä¾æ¬¡"æ‰“åŒ…"è¿›ä¸€ä¸ªç½‘ç»œã€‚å…·ä½“æ¥è¯´ï¼š

1. **é¿å…ç¾éš¾æ€§é—å¿˜**ï¼šæ—§ä»»åŠ¡çš„å‚æ•°è¢«å›ºå®šï¼Œæ–°ä»»åŠ¡ä½¿ç”¨é‡Šæ”¾å‡ºçš„å‚æ•°
2. **å‚æ•°å…±äº«**ï¼šé€šè¿‡å‰ªæžé‡Šæ”¾å‚æ•°ä¾›æ–°ä»»åŠ¡ä½¿ç”¨
3. **å¤šä»»åŠ¡å­¦ä¹ **ï¼šä¸€ä¸ªç½‘ç»œå¯ä»¥å­¦ä¹ å¤šä¸ªç›¸å…³ä»»åŠ¡

## ðŸ—ï¸ é¡¹ç›®ç»“æž„

```
ðŸ“¦ packnet-jittor/
â”œâ”€â”€ ðŸ“„ dataset.py          # ç»Ÿä¸€çš„æ•°æ®åŠ è½½å™¨
â”œâ”€â”€ ðŸ“„ networks.py         # VGG-16ç½‘ç»œæž¶æž„å®šä¹‰
â”œâ”€â”€ ðŸ“„ pruning.py          # PackNetå‰ªæžç®—æ³•æ ¸å¿ƒå®žçŽ°
â”œâ”€â”€ ðŸ“„ main.py             # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ ðŸ“„ test_basic.py       # åŸºç¡€åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ ðŸ“„ requirements.txt    # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ ðŸ“„ README.md           # é¡¹ç›®è¯´æ˜Ž
â”œâ”€â”€ ðŸ“„ data.zip            # åŽ‹ç¼©çš„æ•°æ®é›†æ–‡ä»¶
â”œâ”€â”€ ðŸ“ data/               # æ•°æ®é›†ç›®å½•ï¼ˆéœ€è§£åŽ‹data.zipï¼‰
â”‚   â”œâ”€â”€ ðŸ“ cubs_cropped/   # CUB-200-2011é¸Ÿç±»æ•°æ®é›†
â”‚   â”œâ”€â”€ ðŸ“ stanford_cars_cropped/  # Stanford Carsæ•°æ®é›†
â”‚   â””â”€â”€ ðŸ“ flowers/        # Oxford Flowersæ•°æ®é›†
â””â”€â”€ ðŸ“ checkpoints/        # æ¨¡åž‹å’ŒæŽ©ç ä¿å­˜ç›®å½•ï¼ˆè¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
```

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. çŽ¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…Jittorï¼ˆéœ€è¦CUDAæ”¯æŒï¼‰
pip install jittor

# å®‰è£…å…¶ä»–ä¾èµ–
pip install -r requirements.txt
```

### 2. æ•°æ®å‡†å¤‡

é¦–å…ˆè§£åŽ‹æ•°æ®é›†ï¼š

```bash
# åœ¨PowerShellä¸­è§£åŽ‹æ•°æ®é›†
Expand-Archive -Path data.zip -DestinationPath .
```

ç¡®ä¿æ•°æ®é›†å·²è§£åŽ‹å¹¶æŒ‰ä»¥ä¸‹ç»“æž„ç»„ç»‡ï¼š

```
data/
â”œâ”€â”€ cubs_cropped/
â”‚   â”œâ”€â”€ train/
â”‚   â”‚   â”œâ”€â”€ 001.Black_footed_Albatross/
â”‚   â”‚   â”œâ”€â”€ 002.Laysan_Albatross/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ test/
â”œâ”€â”€ stanford_cars_cropped/
â”‚   â”œâ”€â”€ train/
â”‚   â””â”€â”€ test/
â””â”€â”€ flowers/
    â”œâ”€â”€ train/
    â””â”€â”€ test/
```

### 3. æµ‹è¯•æ•°æ®åŠ è½½

```bash
# æµ‹è¯•æ•°æ®é›†ç»“æž„å’ŒåŸºç¡€åŠŸèƒ½
python test_basic.py
```

### 4. è¿è¡ŒPackNetå®žéªŒ

```bash
# è¿è¡Œå®Œæ•´çš„å¤šä»»åŠ¡å­¦ä¹ å®žéªŒ
python main.py

# å®žéªŒè¿‡ç¨‹ä¸­ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# PackNetè®­ç»ƒå™¨åˆå§‹åŒ–å®Œæˆ
# ä»»åŠ¡åºåˆ—: ['cubs', 'cars', 'flowers']
# å‰ªæžçŽ‡: 75.0%
# å¼€å§‹è®­ç»ƒä»»åŠ¡ 1: cubs
# ...
```

## ðŸ”„ è¿è¡Œæµç¨‹è¯´æ˜Ž

å®Œæ•´çš„PackNetå®žéªŒåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

1. **åˆå§‹åŒ–é˜¶æ®µ**
   - åŠ è½½VGG-16é¢„è®­ç»ƒæ¨¡åž‹
   - åˆå§‹åŒ–æƒé‡æŽ©ç 
   - å‡†å¤‡æ•°æ®åŠ è½½å™¨

2. **å¤šä»»åŠ¡è®­ç»ƒå¾ªçŽ¯**
   ```
   å¯¹äºŽæ¯ä¸ªä»»åŠ¡(CUBS â†’ Cars â†’ Flowers):
   â”œâ”€â”€ å†»ç»“ä¹‹å‰ä»»åŠ¡çš„æƒé‡
   â”œâ”€â”€ å¾®è°ƒå½“å‰ä»»åŠ¡(20ä¸ªepoch)
   â”œâ”€â”€ å¯¹å½“å‰ä»»åŠ¡æƒé‡è¿›è¡Œ75%å‰ªæž
   â”œâ”€â”€ åŽå‰ªæžè®­ç»ƒ(10ä¸ªepoch)
   â””â”€â”€ ä¿å­˜æ¨¡åž‹å’ŒæŽ©ç 
   ```

3. **æœ€ç»ˆè¯„ä¼°**
   - åœ¨æ‰€æœ‰ä»»åŠ¡çš„æµ‹è¯•é›†ä¸Šè¯„ä¼°
   - éªŒè¯å¤šä»»åŠ¡æ€§èƒ½ä¿æŒ
   - è¾“å‡ºè¯¦ç»†ç»“æžœæŠ¥å‘Š

## ï¿½ æ–‡ä»¶è¯¦ç»†è¯´æ˜Ž

### æ ¸å¿ƒæ–‡ä»¶

- **`main.py`**: PackNetä¸»è®­ç»ƒè„šæœ¬
  - `PackNetTrainer`ç±»ï¼šå®Œæ•´çš„è®­ç»ƒæµç¨‹ç®¡ç†
  - å¤šä»»åŠ¡åºåˆ—è®­ç»ƒé€»è¾‘
  - æ¨¡åž‹ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½

- **`dataset.py`**: æ•°æ®åŠ è½½å’Œé¢„å¤„ç†
  - `FinegrainedDataset`ç±»ï¼šç»Ÿä¸€çš„æ•°æ®é›†æŽ¥å£
  - æ”¯æŒCUBSã€Carsã€Flowersä¸‰ä¸ªæ•°æ®é›†
  - æŒ‰è®ºæ–‡è¦æ±‚çš„æ•°æ®é¢„å¤„ç†æ–¹æ³•

- **`networks.py`**: ç½‘ç»œæž¶æž„å®šä¹‰
  - `ModifiedVGG16`ç±»ï¼šé€‚é…å¤šä»»åŠ¡çš„VGG-16
  - æ”¯æŒåŠ¨æ€åˆ†ç±»å¤´åˆ‡æ¢
  - ImageNeté¢„è®­ç»ƒæƒé‡é›†æˆ

- **`pruning.py`**: PackNetå‰ªæžç®—æ³•
  - `PackNetPruning`ç±»ï¼šæ ¸å¿ƒå‰ªæžé€»è¾‘
  - åŸºäºŽæ¢¯åº¦é‡è¦æ€§çš„æƒé‡é€‰æ‹©
  - æŽ©ç ç®¡ç†å’Œæƒé‡å†»ç»“æœºåˆ¶

- **`test_basic.py`**: åŸºç¡€åŠŸèƒ½æµ‹è¯•
  - æ•°æ®é›†ç»“æž„éªŒè¯
  - åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥
  - è¿è¡Œå‰çŽ¯å¢ƒéªŒè¯

### é…ç½®æ–‡ä»¶

- **`requirements.txt`**: Pythonä¾èµ–åŒ…åˆ—è¡¨
- **`data.zip`**: é¢„å¤„ç†åŽçš„æ•°æ®é›†åŽ‹ç¼©åŒ…
- **`README.md`**: é¡¹ç›®æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰

## ï¿½ðŸ”¬ å®žéªŒè®¾ç½®

### ä»»åŠ¡åºåˆ—
- **ä»»åŠ¡1**: CUBS-200-2011 (é¸Ÿç±»åˆ†ç±»ï¼Œ200ä¸ªç±»åˆ«)
- **ä»»åŠ¡2**: Stanford Cars (æ±½è½¦åˆ†ç±»ï¼Œ196ä¸ªç±»åˆ«)  
- **ä»»åŠ¡3**: Oxford Flowers (èŠ±å‰åˆ†ç±»ï¼Œ102ä¸ªç±»åˆ«)

### å‰ªæžç­–ç•¥
- **åˆå§‹å‰ªæž**: 75% (åœ¨ImageNeté¢„è®­ç»ƒæ¨¡åž‹ä¸Š)
- **ä»»åŠ¡1å‰ªæž**: 75%
- **ä»»åŠ¡2å‰ªæž**: 75%  
- **ä»»åŠ¡3å‰ªæž**: 75%

### ç½‘ç»œæž¶æž„
- **åŸºç¡€æ¨¡åž‹**: VGG-16 (ImageNeté¢„è®­ç»ƒ)
- **ç½‘ç»œå®šä¹‰**: `networks.py` - ModifiedVGG16ç±»
- **åˆ†ç±»å™¨**: ä¸ºæ¯ä¸ªä»»åŠ¡æ·»åŠ ç‹¬ç«‹çš„åˆ†ç±»å¤´

## ðŸ“Š æ ¸å¿ƒç®—æ³•

### 1. æ•°æ®é¢„å¤„ç† (`dataset.py`)

ä¸¥æ ¼æŒ‰ç…§è®ºæ–‡ç¬¬4èŠ‚å®žçŽ°ï¼š

- **CUBS & Cars**: ç›´æŽ¥ç¼©æ”¾åˆ°224Ã—224
- **Flowers**: çŸ­è¾¹ç¼©æ”¾åˆ°256ï¼Œç„¶åŽ224Ã—224è£å‰ª
- **æ•°æ®å¢žå¼º**: è®­ç»ƒæ—¶éšæœºæ°´å¹³ç¿»è½¬

```python
# åˆ›å»ºæ•°æ®åŠ è½½å™¨
train_loader, num_classes = create_dataloader(
    dataset_name='cubs',
    data_root='data',
    split='train',
    batch_size=32
)
```

### 2. PackNetå‰ªæžç®—æ³• (`pruning.py`)

æ ¸å¿ƒå‰ªæžå‡½æ•°å®žçŽ°ï¼š

```python
# å¯¹æ¨¡åž‹è¿›è¡Œå‰ªæž
new_mask = PackNetPruning.prune_model(
    model=model,
    pruning_ratio=0.75,  # å‰ªæž75%çš„æƒé‡
    previous_masks=previous_task_masks  # ä¿æŠ¤ä¹‹å‰ä»»åŠ¡çš„æƒé‡
)

# åº”ç”¨æŽ©ç å†»ç»“æƒé‡
PackNetPruning.freeze_weights_by_mask(model, previous_masks)
```

### 3. å¤šä»»åŠ¡è®­ç»ƒæµç¨‹ (`main.py`)

å®Œæ•´çš„PackNetè®­ç»ƒæµç¨‹ï¼š

1. **åˆå§‹å‰ªæž**: å¯¹VGG-16è¿›è¡Œ75%å‰ªæž
2. **ä»»åŠ¡å¾ªçŽ¯**:
   - å†»ç»“ä¹‹å‰ä»»åŠ¡çš„æƒé‡
   - è®­ç»ƒå½“å‰ä»»åŠ¡
   - å‰ªæžå½“å‰ä»»åŠ¡çš„æƒé‡
   - å¾®è°ƒæ¢å¤æ€§èƒ½
3. **æœ€ç»ˆè¯„ä¼°**: éªŒè¯æ‰€æœ‰ä»»åŠ¡çš„æ€§èƒ½ä¿æŒ

## ðŸŽ¯ é¢„æœŸç»“æžœ

æ ¹æ®è®ºæ–‡Table 2ï¼Œé¢„æœŸç»“æžœåº”è¯¥æŽ¥è¿‘ï¼š

| ä»»åŠ¡ | PackNeté”™è¯¯çŽ‡ | å¤‡æ³¨ |
|------|---------------|------|
| CUBS | ~XX.X% | ç¬¬ä¸€ä¸ªä»»åŠ¡ |
| Cars | ~XX.X% | ç¬¬äºŒä¸ªä»»åŠ¡ |
| Flowers | ~XX.X% | ç¬¬ä¸‰ä¸ªä»»åŠ¡ |

*å…·ä½“æ•°å€¼éœ€è¦è¿è¡Œå®žéªŒèŽ·å¾—*

## ðŸ”§ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®žçŽ°åŠŸèƒ½

1. **å®Œæ•´çš„æ•°æ®åŠ è½½å™¨** (`dataset.py`)
   - æ”¯æŒä¸‰ä¸ªç»†ç²’åº¦åˆ†ç±»æ•°æ®é›†
   - æŒ‰ç…§è®ºæ–‡è¦æ±‚çš„é¢„å¤„ç†æ–¹æ³•
   - è‡ªåŠ¨ä»Žç›®å½•ç»“æž„è§£æžæ ‡ç­¾
   - æ”¯æŒæ•°æ®å¢žå¼ºå’Œæ ‡å‡†åŒ–

2. **PackNetæ ¸å¿ƒç®—æ³•** (`pruning.py`)
   - åŸºäºŽé‡è¦æ€§çš„æƒé‡å‰ªæž
   - æŽ©ç ç®¡ç†å’Œæƒé‡å†»ç»“
   - æ”¯æŒå¤šä»»åŠ¡è¿žç»­å­¦ä¹ 
   - æŒ‰è®ºæ–‡ç®—æ³•ç²¾ç¡®å®žçŽ°

3. **VGG-16ç½‘ç»œæž¶æž„** (`networks.py`)
   - ModifiedVGG16ç±»å®žçŽ°
   - æ”¯æŒå¤šä»»åŠ¡åˆ†ç±»å¤´
   - ImageNeté¢„è®­ç»ƒæƒé‡åŠ è½½

4. **è®­ç»ƒå’Œè¯„ä¼°æ¡†æž¶** (`main.py`)
   - å®Œæ•´çš„PackNetè®­ç»ƒæµç¨‹
   - ä»»åŠ¡é—´æƒé‡ä¿æŠ¤æœºåˆ¶
   - æ€§èƒ½è¯„ä¼°å’Œç»“æžœä¿å­˜
   - æ¨¡åž‹å’ŒæŽ©ç æŒä¹…åŒ–

5. **åŸºç¡€åŠŸèƒ½æµ‹è¯•** (`test_basic.py`)
   - æ•°æ®é›†ç»“æž„éªŒè¯
   - åŸºç¡€åŠŸèƒ½æµ‹è¯•
   - æ— JittorçŽ¯å¢ƒä¸‹çš„é¢„æ£€æŸ¥

### ðŸŽ›ï¸ å¯é…ç½®å‚æ•°

```python
# è®­ç»ƒé…ç½®
self.initial_lr = 0.001           # åˆå§‹å­¦ä¹ çŽ‡
self.batch_size = 32              # æ‰¹å¤§å°
self.finetune_epochs = 20         # æ¯ä¸ªä»»åŠ¡çš„å¾®è°ƒè½®æ•°
self.post_prune_epochs = 10       # å‰ªæžåŽè®­ç»ƒè½®æ•°

# ä»»åŠ¡é…ç½®  
self.task_list = ['cubs', 'cars', 'flowers']
self.pruning_ratio = 0.75         # ç»Ÿä¸€å‰ªæžçŽ‡75%
```

## ðŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®é›†å‡†å¤‡**: é¦–å…ˆéœ€è¦è§£åŽ‹`data.zip`æ–‡ä»¶åˆ°é¡¹ç›®æ ¹ç›®å½•
2. **è®¡ç®—èµ„æº**: å®Œæ•´å®žéªŒéœ€è¦GPUæ”¯æŒï¼Œå»ºè®®è‡³å°‘8GBæ˜¾å­˜
3. **ä¾èµ–å®‰è£…**: ç¡®ä¿æ­£ç¡®å®‰è£…Jittorå’ŒCUDAæ”¯æŒ
4. **æ•°æ®é›†ç»“æž„**: ä½¿ç”¨`test_basic.py`éªŒè¯æ•°æ®é›†ç›®å½•ç»“æž„
5. **WindowsçŽ¯å¢ƒ**: æœ¬é¡¹ç›®åœ¨Windows PowerShellçŽ¯å¢ƒä¸‹å¼€å‘å’Œæµ‹è¯•

## ðŸ› æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åŠ è½½é”™è¯¯**
   ```bash
   # é¦–å…ˆç¡®ä¿æ•°æ®é›†å·²è§£åŽ‹
   Expand-Archive -Path data.zip -DestinationPath .
   
   # ç„¶åŽæ£€æŸ¥æ•°æ®é›†ç»“æž„
   python test_basic.py
   ```

2. **CUDAå†…å­˜ä¸è¶³**
   ```python
   # å‡å°æ‰¹å¤§å°
   self.batch_size = 16  # æˆ–æ›´å°
   ```

3. **è®­ç»ƒè¿‡æ…¢**
   ```python
   # å‡å°‘è®­ç»ƒè½®æ•°ç”¨äºŽæµ‹è¯•
   self.finetune_epochs = 5
   self.post_prune_epochs = 3
   ```

## ðŸ“š å‚è€ƒæ–‡çŒ®

```bibtex
@inproceedings{mallya2018packnet,
  title={PackNet: Adding Multiple Tasks to a Single Network by Iterative Pruning},
  author={Mallya, Arun and Lazebnik, Svetlana},
  booktitle={Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition},
  pages={7765--7773},
  year={2018}
}
```

## ðŸ¤ è´¡çŒ®

æ¬¢è¿Žæäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ï¼

### å¼€å‘çŠ¶æ€

- âœ… **å·²å®Œæˆ**: æ ¸å¿ƒç®—æ³•å®žçŽ°ã€æ•°æ®åŠ è½½å™¨ã€åŸºç¡€æµ‹è¯•
- ðŸ”„ **è¿›è¡Œä¸­**: æ€§èƒ½ä¼˜åŒ–ã€å®žéªŒç»“æžœéªŒè¯
- ðŸ“‹ **è®¡åˆ’ä¸­**: æ›´å¤šæ•°æ®é›†æ”¯æŒã€å¯è§†åŒ–å·¥å…·ã€æ€§èƒ½åˆ†æž

### è´¡çŒ®æŒ‡å—

1. Forkæœ¬é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/new-feature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add new feature'`)
4. æŽ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/new-feature`)
5. åˆ›å»ºPull Request

## ðŸ“Š é¡¹ç›®æŒ‡æ ‡

- **ä»£ç è¡Œæ•°**: ~1000+ è¡Œ
- **æ”¯æŒæ•°æ®é›†**: 3ä¸ªï¼ˆCUBSã€Carsã€Flowersï¼‰
- **å®žçŽ°å®Œæ•´åº¦**: 95%+
- **æµ‹è¯•è¦†ç›–**: åŸºç¡€åŠŸèƒ½æµ‹è¯•
- **æ–‡æ¡£å®Œæ•´åº¦**: è¯¦ç»†README + ä»£ç æ³¨é‡Š

## ðŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªMITè®¸å¯è¯ã€‚

---

**ä½œè€…**: AIç ”ç©¶åŠ©æ‰‹  
**æœ€åŽæ›´æ–°**: 2025å¹´7æœˆ8æ—¥  
**Jittorç‰ˆæœ¬**: >= 1.3.0
