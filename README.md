# PackNet-Jittor: åŸºäºJittorçš„PackNetç®—æ³•å®ç°

æœ¬é¡¹ç›®æ˜¯å¯¹CVPR 2018è®ºæ–‡ã€ŠPackNet: Adding Multiple Tasks to a Single Network by Iterative Pruningã€‹çš„å®Œæ•´å¤ç°ï¼Œä½¿ç”¨Jittoræ·±åº¦å­¦ä¹ æ¡†æ¶å®ç°ã€‚

## ğŸ“– è®ºæ–‡ç®€ä»‹

**PackNet**çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨å¤§å‹ç¥ç»ç½‘ç»œä¸­çš„å†—ä½™å‚æ•°ï¼Œé€šè¿‡"è¿­ä»£å‰ªæå’Œé‡è®­ç»ƒ"çš„å¾ªç¯ï¼Œå°†å¤šä¸ªä»»åŠ¡ä¾æ¬¡"æ‰“åŒ…"è¿›ä¸€ä¸ªç½‘ç»œã€‚å…·ä½“æ¥è¯´ï¼š

1. **é¿å…ç¾éš¾æ€§é—å¿˜**ï¼šæ—§ä»»åŠ¡çš„å‚æ•°è¢«å›ºå®šï¼Œæ–°ä»»åŠ¡ä½¿ç”¨é‡Šæ”¾å‡ºçš„å‚æ•°
2. **å‚æ•°å…±äº«**ï¼šé€šè¿‡å‰ªæé‡Šæ”¾å‚æ•°ä¾›æ–°ä»»åŠ¡ä½¿ç”¨
3. **å¤šä»»åŠ¡å­¦ä¹ **ï¼šä¸€ä¸ªç½‘ç»œå¯ä»¥å­¦ä¹ å¤šä¸ªç›¸å…³ä»»åŠ¡

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
ğŸ“¦ packnet-jittor/
â”œâ”€â”€ ğŸ“„ dataset.py          # ç»Ÿä¸€çš„æ•°æ®åŠ è½½å™¨
â”œâ”€â”€ ğŸ“„ pruning.py          # PackNetå‰ªæç®—æ³•æ ¸å¿ƒå®ç°
â”œâ”€â”€ ğŸ“„ main.py             # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ ğŸ“„ test_basic.py       # åŸºç¡€åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ ğŸ“„ requirements.txt    # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ ğŸ“„ README.md           # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ ğŸ“ data/               # æ•°æ®é›†ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“ cubs_cropped/   # CUB-200-2011é¸Ÿç±»æ•°æ®é›†
â”‚   â”œâ”€â”€ ğŸ“ stanford_cars_cropped/  # Stanford Carsæ•°æ®é›†
â”‚   â””â”€â”€ ğŸ“ flowers/        # Oxford Flowersæ•°æ®é›†
â””â”€â”€ ğŸ“ checkpoints/        # æ¨¡å‹å’Œæ©ç ä¿å­˜ç›®å½•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. æ•°æ®å‡†å¤‡

ç¡®ä¿æ•°æ®é›†å·²ä¸‹è½½å¹¶æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ï¼š

```
data/
â”œâ”€â”€ cubs_cropped/
â”‚   â”œâ”€â”€ train/
â”‚   â”‚   â”œâ”€â”€ 001.Black_footed_Albatross/
â”‚   â”‚   â”œâ”€â”€ 002.Laysan_Albatross/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ test/
â”œâ”€â”€ stanford_cars_cropped/
â”‚   â”œâ”€â”€ train/
â”‚   â””â”€â”€ test/
â””â”€â”€ flowers/
    â”œâ”€â”€ train/
    â””â”€â”€ test/
```

### 3. æµ‹è¯•æ•°æ®åŠ è½½

```bash
# æµ‹è¯•æ•°æ®é›†ç»“æ„å’ŒåŸºç¡€åŠŸèƒ½
python test_basic.py
```

### 4. è¿è¡ŒPackNetå®éªŒ

```bash
# è¿è¡Œå®Œæ•´çš„å¤šä»»åŠ¡å­¦ä¹ å®éªŒ
python main.py
```

## ğŸ”¬ å®éªŒè®¾ç½®

### ä»»åŠ¡åºåˆ—
- **ä»»åŠ¡1**: CUBS-200-2011 (é¸Ÿç±»åˆ†ç±»ï¼Œ200ä¸ªç±»åˆ«)
- **ä»»åŠ¡2**: Stanford Cars (æ±½è½¦åˆ†ç±»ï¼Œ196ä¸ªç±»åˆ«)  
- **ä»»åŠ¡3**: Oxford Flowers (èŠ±å‰åˆ†ç±»ï¼Œ102ä¸ªç±»åˆ«)

### å‰ªæç­–ç•¥
- **åˆå§‹å‰ªæ**: 75% (åœ¨ImageNeté¢„è®­ç»ƒæ¨¡å‹ä¸Š)
- **ä»»åŠ¡1å‰ªæ**: 75%
- **ä»»åŠ¡2å‰ªæ**: 75%  
- **ä»»åŠ¡3å‰ªæ**: 75%

### ç½‘ç»œæ¶æ„
- **åŸºç¡€æ¨¡å‹**: VGG-16 (ImageNeté¢„è®­ç»ƒ)
- **åˆ†ç±»å™¨**: ä¸ºæ¯ä¸ªä»»åŠ¡æ·»åŠ ç‹¬ç«‹çš„åˆ†ç±»å¤´

### âš ï¸ç®€åŒ–æµç¨‹
- ä¸ºäº†å¿«é€ŸéªŒè¯ï¼Œæš‚æ—¶æ²¡åœ¨ImageNetä¸Šé‡è®­ç»ƒï¼Œä¹Ÿæ²¡æœ‰å¯¹ImageNetçš„æ€§èƒ½è¿›è¡Œæµ‹è¯•

## ğŸ“Š æ ¸å¿ƒç®—æ³•

### 1. æ•°æ®é¢„å¤„ç† (`dataset.py`)

ä¸¥æ ¼æŒ‰ç…§è®ºæ–‡ç¬¬4èŠ‚å®ç°ï¼š

- **CUBS & Cars**: ç›´æ¥ç¼©æ”¾åˆ°224Ã—224
- **Flowers**: çŸ­è¾¹ç¼©æ”¾åˆ°256ï¼Œç„¶å224Ã—224è£å‰ª
- **æ•°æ®å¢å¼º**: è®­ç»ƒæ—¶éšæœºæ°´å¹³ç¿»è½¬

```python
# åˆ›å»ºæ•°æ®åŠ è½½å™¨
train_loader, num_classes = create_dataloader(
    dataset_name='cubs',
    data_root='data',
    split='train',
    batch_size=32
)
```

### 2. PackNetå‰ªæç®—æ³• (`pruning.py`)

æ ¸å¿ƒå‰ªæå‡½æ•°å®ç°ï¼š

```python
# å¯¹æ¨¡å‹è¿›è¡Œå‰ªæ
new_mask = PackNetPruning.prune_model(
    model=model,
    pruning_ratio=0.75,  # å‰ªæ75%çš„æƒé‡
    previous_masks=previous_task_masks  # ä¿æŠ¤ä¹‹å‰ä»»åŠ¡çš„æƒé‡
)

# åº”ç”¨æ©ç å†»ç»“æƒé‡
PackNetPruning.freeze_weights_by_mask(model, previous_masks)
```

### 3. å¤šä»»åŠ¡è®­ç»ƒæµç¨‹ (`main.py`)

å®Œæ•´çš„PackNetè®­ç»ƒæµç¨‹ï¼š

1. **åˆå§‹å‰ªæ**: å¯¹VGG-16è¿›è¡Œ75%å‰ªæ
2. **ä»»åŠ¡å¾ªç¯**:
   - å†»ç»“ä¹‹å‰ä»»åŠ¡çš„æƒé‡
   - è®­ç»ƒå½“å‰ä»»åŠ¡
   - å‰ªæå½“å‰ä»»åŠ¡çš„æƒé‡
   - å¾®è°ƒæ¢å¤æ€§èƒ½
3. **æœ€ç»ˆè¯„ä¼°**: éªŒè¯æ‰€æœ‰ä»»åŠ¡çš„æ€§èƒ½ä¿æŒ

## ğŸ¯ å®éªŒç»“æœ


### Jittor å¤ç°ç»“æœ vs. è®ºæ–‡æŠ¥å‘Šç»“æœ (Top-1 å‡†ç¡®ç‡ %)

| **ä»»åŠ¡** | **Jittor å¤ç° (æœ¬é¡¹ç›®)** | PyTorchå¤ç° | **åŸè®ºæ–‡ (VGG-16, 75%å‰ªæ)** |
| :--- | :---: | :---: | ----- |
| CUBS | 68.69% | 75.94% | 75.05% (24.95% é”™è¯¯ç‡) |
| Stanford Cars | 79.14% | 83.39% | 84.25% (15.75% é”™è¯¯ç‡) |
| Flowers | 87.74% | 87.43% | 90.25% (9.75% é”™è¯¯ç‡) |

* ImageNetå‰ªæåæ²¡æœ‰è¿›è¡Œé‡è®­ç»ƒä½¿æ€§èƒ½æ¢å¤ã€‚ImageNetçš„å‚æ•°å¯¹åç»­ä»»åŠ¡éƒ½ä¼šç”¨åˆ°ï¼Œè¿™å¯èƒ½å½±å“æ€§èƒ½ã€‚
* æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸åŒã€‚

### è®­ç»ƒè¿‡ç¨‹ï¼ˆCUBSï¼‰

![image-20250714104323383](image-20250714104323383.png)

è®­ç»ƒå®Œæ•´logåœ¨log.txtä¸­ã€‚æ€»è®­ç»ƒæ—¶é•¿115minå·¦å³ã€‚

### ç¼“è§£ç¾éš¾æ€§é—å¿˜æ•ˆæœ

#### Jittor

![image-20250714104517345](image-20250714104517345.png)

#### PyTorchå¤ç°

![image-20250718155000567](image-20250718155000567.png)

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **å®Œæ•´çš„æ•°æ®åŠ è½½å™¨**
   - æ”¯æŒä¸‰ä¸ªç»†ç²’åº¦åˆ†ç±»æ•°æ®é›†
   - æŒ‰ç…§è®ºæ–‡è¦æ±‚çš„é¢„å¤„ç†æ–¹æ³•
   - è‡ªåŠ¨ä»ç›®å½•ç»“æ„è§£ææ ‡ç­¾

2. **PackNetæ ¸å¿ƒç®—æ³•**
   - åŸºäºé‡è¦æ€§çš„æƒé‡å‰ªæ
   - æ©ç ç®¡ç†å’Œæƒé‡å†»ç»“
   - æ”¯æŒå¤šä»»åŠ¡è¿ç»­å­¦ä¹ 

3. **è®­ç»ƒå’Œè¯„ä¼°æ¡†æ¶**
   - å®Œæ•´çš„è®­ç»ƒå¾ªç¯
   - æ€§èƒ½è¯„ä¼°å’Œç»“æœä¿å­˜
   - æ¨¡å‹å’Œæ©ç æŒä¹…åŒ–

### ğŸ›ï¸ å¯é…ç½®å‚æ•°

```python
# è®­ç»ƒé…ç½®
self.initial_lr = 0.001           # åˆå§‹å­¦ä¹ ç‡
self.batch_size = 32              # æ‰¹å¤§å°
self.num_epochs_per_task = 50     # æ¯ä¸ªä»»åŠ¡çš„è®­ç»ƒè½®æ•°
self.num_epochs_finetune = 10     # å‰ªæåå¾®è°ƒè½®æ•°

# ä»»åŠ¡é…ç½®  
self.task_list = ['cubs', 'cars', 'flowers']
self.pruning_ratios = [0.75, 0.75, 0.75]
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **è®¡ç®—èµ„æº**: å®Œæ•´å®éªŒéœ€è¦GPUæ”¯æŒï¼Œå»ºè®®è‡³å°‘8GBæ˜¾å­˜
2. **æ•°æ®é›†å‡†å¤‡**: ç¡®ä¿æ•°æ®é›†ç›®å½•ç»“æ„æ­£ç¡®
3. **Jittorå®‰è£…**: éœ€è¦æ­£ç¡®å®‰è£…Jittoræ”¯æŒï¼ŒJittorçš„å®‰è£…éœ€è¦æŠ˜è…¾

âš ï¸å°è¯•åœ¨DCUä¸Šå®‰è£…Jittorå¹¶è®­ç»ƒï¼Œä½†å†…æ ¸æŠ¥é”™

## ğŸ“š å‚è€ƒæ–‡çŒ®

```bibtex
@inproceedings{mallya2018packnet,
  title={PackNet: Adding Multiple Tasks to a Single Network by Iterative Pruning},
  author={Mallya, Arun and Lazebnik, Svetlana},
  booktitle={Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition},
  pages={7765--7773},
  year={2018}
}
```
